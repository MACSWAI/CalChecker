<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calorie Tracker</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 p-4 text-gray-800">
    <div class="max-w-md mx-auto">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-xl font-bold">Halo, <span id="user-name">User</span>!</h1>
            <div id="bmi-tag" class="px-3 py-1 bg-blue-500 text-white text-xs rounded-full hidden"></div>
        </header>

        <div class="bg-white p-4 rounded-2xl shadow-sm mb-6">
            <h2 class="text-sm text-gray-400 mb-2">Progress Kalori (7 Hari)</h2>
            <canvas id="chart"></canvas>
        </div>

        <h3 class="font-bold mb-3">Riwayat Makan</h3>
        <div id="logs" class="space-y-3"></div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const user = tg.initDataUnsafe.user || { id: 0, first_name: "Guest" };
        document.getElementById('user-name').innerText = user.first_name;

        const SUPABASE_URL = "https://XYZ.supabase.co"; // GANTI
        const SUPABASE_KEY = "YOUR_ANON_KEY"; // GANTI
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function fetchData() {
            // Get Profile
            const { data: profile } = await supabaseClient.from('profiles').select('*').eq('id', user.id).single();
            if (profile) {
                const tag = document.getElementById('bmi-tag');
                tag.innerText = `BMI: ${profile.bmi} (${profile.bmi_category})`;
                tag.classList.remove('hidden');
            }

            // Get Logs
            const { data: logs } = await supabaseClient.from('calorie_logs')
                .select('*').eq('user_id', user.id).order('created_at', { ascending: false });

            renderChart(logs || []);
            renderLogs(logs || []);
        }

        function renderChart(logs) {
            const ctx = document.getElementById('chart').getContext('2d');
            const last7Days = logs.slice(0, 10).reverse();
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days.map(l => new Date(l.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })),
                    datasets: [{ label: 'kcal', data: last7Days.map(l => l.calories), borderColor: '#3b82f6', fill: true }]
                }
            });
        }

        function renderLogs(logs) {
            const container = document.getElementById('logs');
            container.innerHTML = logs.map(l => `
                <div class="bg-white p-4 rounded-xl flex justify-between shadow-sm">
                    <div>
                        <p class="font-bold text-gray-700">${l.food_name}</p>
                        <p class="text-xs text-gray-400">${new Date(l.created_at).toLocaleString()}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-blue-600 font-bold">${l.calories} kcal</p>
                        <p class="text-[10px] text-gray-400">P:${l.protein} C:${l.carbs} L:${l.fat}</p>
                    </div>
                </div>
            `).join('');
        }

        fetchData();
    </script>
</body>

</html>